<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MMU Connect â€“ Chat</title>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #f4f4f4;
    }

    .navbar {
      background-color: #7642aa;
      color: white;
      padding: 15px 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .navbar .logo {
      position: absolute;
      left: 30px;
      font-size: 22px;
      font-weight: bold;
    }

    .nav-links {
      list-style: none;
      display: flex;
      gap: 25px;
      margin: 0;
      padding: 0;
    }

    .nav-links li a {
      color: white;
      text-decoration: none;
      font-weight: bold;
    }

    .nav-links li a:hover {
      text-decoration: underline;
    }

    .center-wrapper {
      display: flex;
      justify-content: center;
      align-items: center;
      height: calc(100vh - 70px);
      padding: 20px;
    }

    .chat-container {
      display: flex;
      background-color: #fff;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
      width: 900px;
      max-width: 100%;
      height: 500px;
    }

    #sidebar {
      width: 250px;
      background: #eee;
      padding: 20px;
      overflow-y: auto;
      border-right: 1px solid #ccc;
    }

    #recent-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    #recent-list li {
      padding: 8px 10px;
      margin-bottom: 5px;
      background-color: #fff;
      border-radius: 5px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .notification {
      background-color: red;
      color: white;
      padding: 2px 6px;
      font-size: 12px;
      border-radius: 10px;
    }

    .chat-main {
      flex: 1;
      padding: 20px;
      display: flex;
      flex-direction: column;
    }

    #messages {
      flex: 1;
      border: 1px solid #ccc;
      padding: 10px;
      overflow-y: auto;
      margin-bottom: 10px;
      background-color: #fafafa;
      display: flex;
      flex-direction: column;
    }

    .message {
      max-width: 70%;
      margin-bottom: 10px;
      padding: 10px;
      border-radius: 10px;
      word-wrap: break-word;
    }

    .sent {
      background-color: #d1c4e9;
      align-self: flex-end;
      text-align: right;
    }

    .received {
      background-color: #e0e0e0;
      align-self: flex-start;
      text-align: left;
    }

    .chat-controls {
      display: flex;
      gap: 10px;
    }

    .chat-controls input {
      flex: 1;
      padding: 10px;
      font-size: 16px;
    }

    .chat-controls button {
      padding: 10px 20px;
      font-size: 16px;
      background-color: #7642aa;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 5px;
    }

    .chat-controls button:hover {
      background-color: #5e3291;
    }

    .chat-main input[type="text"] {
      margin-bottom: 10px;
      padding: 8px;
      font-size: 16px;
    }

    #context-menu {
      position: absolute;
      display: none;
      background: white;
      border: 1px solid #ccc;
      z-index: 1000;
    }

    #context-menu div {
      padding: 8px 12px;
      cursor: pointer;
    }

    #context-menu div:hover {
      background-color: #f0f0f0;
    }

    .message:hover {
      outline: 1px dashed #bbb;
      cursor: context-menu;
    }
  </style>
</head>
<body>

  <nav class="navbar">
    <div class="logo">MMU Connect</div>
    <ul class="nav-links">
      <li><a href="/home/">Home</a></li>
      <li><a href="/chat/">Chat</a></li>
      <li><a href="/feature/">Feature</a></li>
      <li><a href="/about-us/">About Us</a></li>
      <li><a href="/contact/">Contact</a></li>
      <li><a href="/edit_profile/">Edit Profile</a></li>
      <li><a href="/logout/">Logout</a></li>
    </ul>
  </nav>

  <div class="center-wrapper">
    <div class="chat-container">
      <div id="sidebar">
        <h3>Recent Chats</h3>
        <ul id="recent-list"></ul>
      </div>

      <div class="chat-main">
        <input id="username" type="text" placeholder="Your username" />
        <input id="chatWith" type="text" placeholder="Friend's username" />
        <div id="messages"></div>
        <div class="chat-controls">
          <input id="chat-input" type="text" placeholder="Type a message..." />
          <button id="send-btn">Send</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Right-click context menu -->
  <div id="context-menu">
    <div id="delete-me">Delete for me</div>
    <div id="delete-everyone">Delete for everyone</div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const usernameInput = document.getElementById('username');
      const chatWithInput = document.getElementById('chatWith');
      const chatInput = document.getElementById('chat-input');
      const sendBtn = document.getElementById('send-btn');
      const messagesDiv = document.getElementById('messages');
      const recentList = document.getElementById('recent-list');
      const contextMenu = document.getElementById('context-menu');
      const deleteMe = document.getElementById('delete-me');
      const deleteEveryone = document.getElementById('delete-everyone');

      let selectedMessageIndex = null;
      let selectedChatKey = null;
      let selectedMessageSender = null;

      const getChatKey = (a, b) => {
        return `chat_${[a, b].sort().join('_')}`;
      };

      const getRecentKey = user => `recentChats_${user}`;
      const getNotificationKey = user => `notifications_${user}`;

      function renderMessages() {
        const user = usernameInput.value.trim();
        const friend = chatWithInput.value.trim();
        if (!user || !friend || user === friend) return;

        const chatKey = getChatKey(user, friend);
        const history = JSON.parse(localStorage.getItem(chatKey)) || [];

        messagesDiv.innerHTML = '';
        history.forEach(({ sender, text }, i) => {
          const div = document.createElement('div');
          div.classList.add('message', sender === user ? 'sent' : 'received');
          div.textContent = (sender === user ? 'You: ' : `${sender}: `) + text;
          messagesDiv.appendChild(div);
        });

        messagesDiv.scrollTop = messagesDiv.scrollHeight;

        const notifyKey = getNotificationKey(user);
        const notis = JSON.parse(localStorage.getItem(notifyKey)) || {};
        delete notis[friend];
        localStorage.setItem(notifyKey, JSON.stringify(notis));
        renderRecentChats();
      }

      function sendMessage() {
        const user = usernameInput.value.trim();
        const friend = chatWithInput.value.trim();
        const text = chatInput.value.trim();
        if (!user || !friend || !text || user === friend) return;

        const chatKey = getChatKey(user, friend);
        const history = JSON.parse(localStorage.getItem(chatKey)) || [];
        history.push({ sender: user, text });
        localStorage.setItem(chatKey, JSON.stringify(history));
        chatInput.value = '';

        // notify
        const notifyKey = getNotificationKey(friend);
        const notis = JSON.parse(localStorage.getItem(notifyKey)) || {};
        notis[user] = 1;
        localStorage.setItem(notifyKey, JSON.stringify(notis));

        addToRecent(user, friend);
        addToRecent(friend, user);
        renderMessages();
      }

      function addToRecent(user, friend) {
        const key = getRecentKey(user);
        let list = JSON.parse(localStorage.getItem(key)) || [];
        list = [friend, ...list.filter(f => f !== friend)].slice(0, 10);
        localStorage.setItem(key, JSON.stringify(list));
      }

      function renderRecentChats() {
        const user = usernameInput.value.trim();
        const list = JSON.parse(localStorage.getItem(getRecentKey(user))) || [];
        const notis = JSON.parse(localStorage.getItem(getNotificationKey(user))) || {};
        recentList.innerHTML = '';
        list.forEach(friend => {
          const li = document.createElement('li');
          li.innerHTML = `<span>${friend}</span>`;
          if (notis[friend]) {
            const badge = document.createElement('span');
            badge.className = 'notification';
            badge.textContent = '1 noti';
            li.appendChild(badge);
          }
          li.addEventListener('click', () => {
            chatWithInput.value = friend;
            renderMessages();
          });
          recentList.appendChild(li);
        });
      }

      // Context menu
      messagesDiv.addEventListener('contextmenu', e => {
        e.preventDefault();
        const message = e.target.closest('.message');
        if (!message) return;
        selectedMessageIndex = Array.from(messagesDiv.children).indexOf(message);
        const user = usernameInput.value.trim();
        const friend = chatWithInput.value.trim();
        selectedChatKey = getChatKey(user, friend);
        const history = JSON.parse(localStorage.getItem(selectedChatKey)) || [];
        selectedMessageSender = history[selectedMessageIndex]?.sender;
        contextMenu.style.top = `${e.pageY}px`;
        contextMenu.style.left = `${e.pageX}px`;
        contextMenu.style.display = 'block';
      });

      document.addEventListener('click', () => {
        contextMenu.style.display = 'none';
      });

      deleteMe.addEventListener('click', () => {
        const history = JSON.parse(localStorage.getItem(selectedChatKey)) || [];
        history.splice(selectedMessageIndex, 1);
        localStorage.setItem(selectedChatKey, JSON.stringify(history));
        renderMessages();
      });

      deleteEveryone.addEventListener('click', () => {
        const user = usernameInput.value.trim();
        const history = JSON.parse(localStorage.getItem(selectedChatKey)) || [];
        if (selectedMessageSender !== user) {
          alert("You can only delete your own message for everyone.");
          return;
        }
        history.splice(selectedMessageIndex, 1);
        localStorage.setItem(selectedChatKey, JSON.stringify(history));
        renderMessages();
      });

      sendBtn.addEventListener('click', sendMessage);
      chatInput.addEventListener('keypress', e => {
        if (e.key === 'Enter') sendMessage();
      });

      usernameInput.addEventListener('change', () => {
        renderRecentChats();
        renderMessages();
      });

      chatWithInput.addEventListener('change', renderMessages);
    });
  </script>
</body>
</html>
